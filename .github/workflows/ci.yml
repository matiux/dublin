name: "CI"

on:
  workflow_dispatch:
    inputs:
      php:
        description: "Run CI for a single PHP version (8.4 or 8.5). Leave empty to run full matrix."
        required: false
        default: ""
        type: string

  pull_request:
    branches: ["main"]

  push:
    branches: ["main"]

  schedule:
    - cron: "37 13 * * 1"

jobs:
  tests:
    name: "Tests (PHP ${{ matrix.php-version }})"
    runs-on: "ubuntu-22.04"

    strategy:
      fail-fast: false
      matrix:
        php-version: ${{ fromJSON((github.event_name == 'workflow_dispatch' && github.event.inputs.php != '') && format('["{0}"]', github.event.inputs.php) || '["8.4","8.5"]') }}

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Install PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "${{ matrix.php-version }}"
          coverage: "none"
          tools: "composer:v2"

      - name: "Validate composer.json and composer.lock"
        run: "composer validate --strict --no-interaction --ansi"

      - name: "Install dependencies with Composer"
        uses: "ramsey/composer-install@v3"
        with:
          composer-options: "--no-interaction --prefer-dist --ansi"

      - name: "Run tests"
        run: "make test"

  qa:
    name: "QA (CS Fixer + PHPStan) (PHP 8.5)"
    runs-on: "ubuntu-22.04"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Install PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "8.5"
          coverage: "none"
          tools: "composer:v2"

      - name: "Install dependencies with Composer"
        uses: "ramsey/composer-install@v3"
        with:
          composer-options: "--no-interaction --prefer-dist --ansi"

      - name: "Run QA"
        run: "make qa"
