name: "CI"

on:
  workflow_dispatch:
    inputs:
      php:
        description: "Run CI for a single PHP version (8.4 or 8.5). Leave empty to run full matrix."
        required: false
        default: ""
        type: string

  pull_request:
    branches: ["main"]

  push:
    branches: ["main"]

  schedule:
    - cron: "37 13 * * 1"

jobs:
  static-analysis:
    name: "static analysis"
    runs-on: "ubuntu-latest"
    steps:
      - name: "checkout"
        uses: "actions/checkout@v2"

      - name: "installing PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "8.5"
          ini-values: memory_limit=-1
          tools: composer:v2, cs2pr
          extensions: bcmath, mbstring, intl, sodium, json

      - name: Install dependencies
        run: composer install

      - name: "running static analysis"
        run: ./tools/bin/project/project stan
  coding-standards:
    name: "coding standards"
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout
        uses: "actions/checkout@v2"

      - name: "installing PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "8.4"
          ini-values: memory_limit=-1
          tools: composer:v2, cs2pr
          extensions: bcmath, mbstring, intl, sodium, json

      - name: Install dependencies
        run: composer install

      - name: "coding-standard-check"
        run: ./tools/bin/project/project coding-standard-check-all
  tests:
    name: "Tests (PHP ${{ matrix.php-version }})"
    runs-on: "ubuntu-22.04"

    strategy:
      fail-fast: false
      matrix:
        php-version: ${{ fromJSON((github.event_name == 'workflow_dispatch' && github.event.inputs.php != '') && format('["{0}"]', github.event.inputs.php) || '["8.4","8.5"]') }}

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Install PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "${{ matrix.php-version }}"
          coverage: "none"
          tools: "composer:v2"

      - name: "Validate composer.json and composer.lock"
        run: "composer validate --strict --no-interaction --ansi"

      - name: "Install dependencies with Composer"
        uses: "ramsey/composer-install@v3"
        with:
          composer-options: "--no-interaction --prefer-dist --ansi"

      - name: "Run tests"
        run: ./tools/bin/project/project phpunit-tdox